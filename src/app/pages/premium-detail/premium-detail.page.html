<ion-header collapse="fade" [translucent]="true">
  <ion-toolbar color="dark">
    <ion-buttons slot="start">
      <ion-back-button color="secondary" text="Premium" defaultHref="/premium"></ion-back-button>
    </ion-buttons>
    <ion-title color="light">{{ qTitle || 'Questionario Premium' }}</ion-title>
  </ion-toolbar>
</ion-header>

<ion-content [fullscreen]="true" class="q-page">
  <!-- Intro dinamica -->
  <section class="intro ion-padding" aria-labelledby="intro-title">
    <h1 id="intro-title">{{ qTitle || 'Questionario Premium' }}</h1>
    <p class="lead-intro" *ngIf="qDesc; else defaultDesc">{{ qDesc }}</p>
    <ng-template #defaultDesc>
      <p class="lead-intro">
        Compila le domande. Dopo l’invio, vai in <strong>Diritti (AI)</strong>:
        i risultati si aggiornano entro pochi minuti.
      </p>
    </ng-template>
  </section>

  <!-- Step bar + dots -->
  <section *ngIf="questions?.length" class="stepbar ion-padding-horizontal" aria-label="Avanzamento questionario">
    <div class="row">
      <span class="step-label">{{ stepEmoji }} {{ stepLabel }}</span>
      <span class="step-percent">{{ ((currentStep + 1) / totalSteps * 100) | number:'1.0-0' }}%</span>
    </div>

    <ion-progress-bar
      [value]="(currentStep + 1) / totalSteps"
      aria-label="Progresso"
      [attr.aria-valuenow]="(currentStep + 1)"
      [attr.aria-valuemin]="1"
      [attr.aria-valuemax]="totalSteps">
    </ion-progress-bar>

    <div *ngIf="totalSteps > 1" class="dots" role="tablist" aria-label="Navigazione step">
      <button
        *ngFor="let i of stepsArray()"
        type="button"
        class="dot"
        [class.active]="i === currentStep"
        [class.done]="i < currentStep"
        (click)="goToStep(i)"
        [disabled]="i > currentStep"
        role="tab"
        [attr.aria-selected]="i === currentStep"
        [attr.aria-label]="'Vai allo step ' + (i + 1)">
      </button>
    </div>
  </section>

  <!-- Form -->
  <form *ngIf="questionarioForm" [formGroup]="questionarioForm" (ngSubmit)="submit()" novalidate>
    <ion-list class="white-card" lines="full">
      <ion-list-header>
        <ion-label>
          <strong>{{ stepEmoji }} {{ stepLabel }}</strong>
          <p class="hint">Compila i campi di questa sezione. Puoi tornare indietro quando vuoi.</p>
        </ion-label>

        <ion-chip *ngIf="isComplete" color="success" slot="end">
          <ion-icon name="checkmark-circle-outline"></ion-icon>
          <ion-label>Completato</ion-label>
        </ion-chip>
      </ion-list-header>

      <!-- Campi dello step corrente -->
      <ng-container *ngFor="let q of questions | slice:(currentStep * pageSize):(currentStep + 1) * pageSize">

        <!-- Number -->
        <ion-item *ngIf="(q.tipo || '').toLowerCase() === 'number'" class="q-item">
          <ion-label position="floating">{{ q.testo_domanda }}</ion-label>
          <ion-input type="number" [formControlName]="q.id.toString()"></ion-input>
        </ion-item>

        <!-- Text -->
        <ion-item *ngIf="(q.tipo || '').toLowerCase() === 'testo_libero' || (q.tipo || '').toLowerCase() === 'text'" class="q-item">
          <ion-label position="floating">{{ q.testo_domanda }}</ion-label>
          <ion-input type="text" [formControlName]="q.id.toString()"></ion-input>
        </ion-item>

        <!-- Textarea -->
        <ion-item *ngIf="(q.tipo || '').toLowerCase() === 'textarea'" class="q-item">
          <ion-label position="floating">{{ q.testo_domanda }}</ion-label>
          <ion-textarea auto-grow="true" [formControlName]="q.id.toString()"></ion-textarea>
        </ion-item>

        <!-- Select -->
        <ion-item *ngIf="(q.tipo || '').toLowerCase() === 'select'" class="q-item">
          <ion-label position="floating">{{ q.testo_domanda }}</ion-label>
          <ion-select interface="action-sheet" [formControlName]="q.id.toString()">
            <ion-select-option *ngFor="let opt of q.opzioni" [value]="opt">{{ opt }}</ion-select-option>
          </ion-select>
        </ion-item>

        <!-- UPLOAD (solo se q.tipo === 'upload') -->
        <div *ngIf="(q.tipo || '').toLowerCase() === 'upload'" class="q-item ion-padding-vertical upload-block">
          <h3 class="upload-title">{{ q.testo_domanda }}</h3>

          <ion-list lines="none" class="upload-list">
            <ion-item *ngFor="let opt of q.opzioni" class="upload-row">
              <ion-label class="upload-label">
                <div class="u-name">{{ opt?.nome }}</div>

                <!-- in coda -->
                <div class="u-file" *ngIf="uploadsQueue[q.id]?.[opt.id]?.file as f">
                  <ion-badge color="tertiary" class="u-badge">In coda</ion-badge>
                  <span class="u-filename">{{ f.name }}</span>
                </div>

                <!-- collegato (anche auto-prefill) -->
                <div class="u-file" *ngIf="!uploadsQueue[q.id]?.[opt.id]?.file && displayFilename(q.id, opt.id) as friendlyName">
                  <ion-badge color="success" class="u-badge">Collegato</ion-badge>
                  <span class="u-filename">
                    <ng-container *ngIf="uploadsVisuals[q.id]?.[opt.id]?.url; else noLink">
                      <a [href]="uploadsVisuals[q.id][opt.id].url" target="_blank" rel="noopener">{{ friendlyName }}</a>
                    </ng-container>
                    <ng-template #noLink>{{ friendlyName }}</ng-template>
                  </span>
                </div>

                <!-- nessun file -->
                <div class="u-file empty" *ngIf="!uploadsQueue[q.id]?.[opt.id]?.file && !displayFilename(q.id, opt.id)">
                  <ion-badge color="medium" class="u-badge">Nessun file</ion-badge>
                </div>
              </ion-label>

              <div class="upload-actions" slot="end">
                <!-- Scegli nuovo file -->
                <input
                  #fileInput
                  type="file"
                  hidden
                  accept=".pdf,.jpg,.jpeg,.png,.heic,.heif,.doc,.docx,.xls,.xlsx"
                  (change)="onFileChosen($event, q.id, opt)"
                />
                <ion-button fill="outline"
                            (click)="onPickClick(fileInput)"
                            [disabled]="isComplete"
                            [attr.aria-label]="'Scegli file per ' + (opt?.nome || '')">
                  <ion-icon slot="start" name="document-attach-outline"></ion-icon>
                  Scegli
                </ion-button>

                <!-- Rimuovi dal questionario (solo locale + autosave, niente delete fisico) -->
                <ion-button color="medium"
                            fill="clear"
                            *ngIf="uploadsQueue[q.id]?.[opt.id]?.file || displayFilename(q.id, opt.id)"
                            (click)="clearChosen(q.id, opt)"
                            [disabled]="isComplete"
                            [attr.aria-label]="'Rimuovi file ' + (opt?.nome || '')">
                  <ion-icon slot="icon-only" name="trash-outline"></ion-icon>
                </ion-button>
              </div>
            </ion-item>
          </ion-list>

          <ion-note class="hint ion-padding-top">
            Se hai già caricato un documento con questa tipologia, lo colleghiamo automaticamente.
            <strong>I file nuovi vengono inviati subito dopo la selezione.</strong>
          </ion-note>
        </div>
      </ng-container>
    </ion-list>

    <!-- Navigazione / Submit -->
    <div class="wizard-nav ion-padding">
      <ion-button fill="outline" (click)="prevStep()" [disabled]="currentStep === 0">
        <ion-icon slot="start" name="chevron-back-outline"></ion-icon>
        Indietro
      </ion-button>

      <div class="spacer"></div>

      <ion-button *ngIf="currentStep < totalSteps - 1"
                  (click)="nextStep()"
                  [disabled]="!isStepValid() || isComplete">
        Avanti
        <ion-icon slot="end" name="chevron-forward-outline"></ion-icon>
      </ion-button>

      <ion-button *ngIf="currentStep === totalSteps - 1"
                  type="submit"
                  color="tertiary"
                  [disabled]="questionarioForm.invalid || isComplete">
        Invia questionario
      </ion-button>

      <ion-note class="subhint" *ngIf="currentStep === totalSteps - 1 && !isComplete">
        Dopo l’invio, la sezione <strong>Diritti (AI)</strong> si aggiornerà entro pochi minuti.
      </ion-note>
      <ion-note class="subhint" color="success" *ngIf="isComplete">
        Questionario già inviato. Puoi rivedere le risposte.
      </ion-note>
    </div>
  </form>
</ion-content>
