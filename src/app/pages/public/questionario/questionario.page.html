<ion-header collapse="fade" [translucent]="true">
  <ion-toolbar color="dark">
    <ion-buttons slot="start">
      <ion-back-button color="secondary" text="Home" defaultHref="/home"></ion-back-button>
    </ion-buttons>
    <ion-title color="light">Questionario</ion-title>
  </ion-toolbar>
</ion-header>

<ion-content [fullscreen]="true" class="q-page">
  <!-- Intro -->
  <section class="intro ion-padding" aria-labelledby="intro-title">
    <h1 id="intro-title">Panoramica familiare</h1>
    <p class="lead-intro">
      Compila le domande. Dopo l’invio, vai in <strong>Diritti (AI)</strong>: i risultati si aggiornano entro pochi minuti.
    </p>
  </section>

  <!-- Step bar + dots -->
  <section *ngIf="questions?.length" class="stepbar ion-padding-horizontal" aria-label="Avanzamento questionario">
    <div class="row">
      <span class="step-label">{{ stepEmoji }} {{ stepLabel }}</span>
      <span class="step-percent">{{ ((currentStep + 1) / totalSteps * 100) | number:'1.0-0' }}%</span>
    </div>

    <ion-progress-bar
      [value]="(currentStep + 1) / totalSteps"
      aria-label="Progresso"
      [attr.aria-valuenow]="(currentStep + 1)"
      [attr.aria-valuemin]="1"
      [attr.aria-valuemax]="totalSteps">
    </ion-progress-bar>

    <div *ngIf="totalSteps > 1" class="dots" role="tablist" aria-label="Navigazione step">
      <button
        *ngFor="let i of stepsArray()"
        type="button"
        class="dot"
        [class.active]="i === currentStep"
        [class.done]="i < currentStep"
        (click)="goToStep(i)"
        [disabled]="i > currentStep"
        role="tab"
        [attr.aria-selected]="i === currentStep"
        [attr.aria-label]="'Vai allo step ' + (i + 1)">
      </button>
    </div>
  </section>

  <!-- Form -->
  <form *ngIf="questionarioForm" [formGroup]="questionarioForm" (ngSubmit)="submit()" novalidate>
    <ion-list class="white-card" lines="full">
      <ion-list-header>
        <ion-label>
          <strong>{{ stepEmoji }} {{ stepLabel }}</strong>
          <p class="hint">Compila i campi di questa sezione. Puoi tornare indietro quando vuoi.</p>
        </ion-label>

        <ion-chip *ngIf="isComplete" color="success" slot="end">
          <ion-icon name="checkmark-circle-outline"></ion-icon>
          <ion-label>Completato</ion-label>
        </ion-chip>
      </ion-list-header>

      <!-- Campi dello step corrente -->
      <ng-container *ngFor="let q of questions | slice:(currentStep * pageSize):(currentStep + 1) * pageSize">
        <!-- Number -->
        <ion-item *ngIf="q.tipo === 'number'" class="q-item">
          <ion-label position="floating">{{ q.testo_domanda }}</ion-label>
          <ion-input type="number" [formControlName]="q.id" [disabled]="isComplete"></ion-input>
        </ion-item>

        <!-- Text -->
        <ion-item *ngIf="q.tipo === 'testo_libero' || q.tipo === 'text'" class="q-item">
          <ion-label position="floating">{{ q.testo_domanda }}</ion-label>
          <ion-input type="text" [formControlName]="q.id" [disabled]="isComplete"></ion-input>
        </ion-item>

        <!-- Textarea -->
        <ion-item *ngIf="q.tipo === 'textarea'" class="q-item">
          <ion-label position="floating">{{ q.testo_domanda }}</ion-label>
          <ion-textarea auto-grow="true" [formControlName]="q.id" [disabled]="isComplete"></ion-textarea>
        </ion-item>

        <!-- Select -->
        <ion-item *ngIf="q.tipo === 'select'" class="q-item">
          <ion-label position="floating">{{ q.testo_domanda }}</ion-label>
          <ion-select interface="action-sheet" [formControlName]="q.id" [disabled]="isComplete">
            <ion-select-option *ngFor="let opt of q.opzioni" [value]="opt">{{ opt }}</ion-select-option>
          </ion-select>
        </ion-item>
      </ng-container>
    </ion-list>

    <!-- Navigazione / Submit -->
    <div class="wizard-nav ion-padding">
      <ion-button fill="outline" (click)="prevStep()" [disabled]="currentStep === 0">
        <ion-icon slot="start" name="chevron-back-outline"></ion-icon>
        Indietro
      </ion-button>

      <div class="spacer"></div>

      <ion-button *ngIf="currentStep < totalSteps - 1"
                  (click)="nextStep()"
                  [disabled]="!isStepValid() || isComplete">
        Avanti
        <ion-icon slot="end" name="chevron-forward-outline"></ion-icon>
      </ion-button>

      <ion-button *ngIf="currentStep === totalSteps - 1"
                  type="submit"
                  color="tertiary"
                  [disabled]="questionarioForm.invalid || isComplete">
        Invia questionario
      </ion-button>

      <ion-note class="subhint" *ngIf="currentStep === totalSteps - 1 && !isComplete">
        Dopo l’invio, la sezione <strong>Diritti (AI)</strong> si aggiornerà entro pochi minuti.
      </ion-note>
      <ion-note class="subhint" color="success" *ngIf="isComplete">
        Questionario già inviato. Puoi rivedere le risposte.
      </ion-note>
    </div>
  </form>
</ion-content>
