<ion-header collapse="fade" [translucent]="true" class="app-header">
  <ion-toolbar color="dark">
    <ion-buttons slot="start">
      <ion-back-button
        defaultHref="/home"
        text="Indietro"
        color="secondary"
        icon="chevron-back"
        aria-label="Torna indietro">
      </ion-back-button>
    </ion-buttons>

    <ion-title class="title-light">
      Chat Premium
    </ion-title>

    <ion-buttons slot="primary">
      <ion-button color="secondary" (click)="refreshContext()" aria-label="Aggiorna contesto">
        <ion-icon slot="icon-only" name="refresh-outline"></ion-icon>
      </ion-button>
    </ion-buttons>
  </ion-toolbar>
</ion-header>

<ion-content [fullscreen]="true" class="page-chat" [scrollEvents]="true">
  <ion-header collapse="condense">
    <ion-toolbar>
      <ion-title size="large">Chat</ion-title>
    </ion-toolbar>
  </ion-header>

  <ion-refresher slot="fixed" (ionRefresh)="doRefresh($event)">
    <ion-refresher-content></ion-refresher-content>
  </ion-refresher>

  <div class="chat-wrapper ion-padding">
    <!-- Pill di stato contesto -->
    <div class="context-pill" *ngIf="ready; else notReady">
      <ion-chip color="success" class="dense">
        <ion-icon name="checkmark-circle-outline"></ion-icon>
        <ion-label>Contesto pronto (QID: {{questionarioId}} · RID: {{resultId}})</ion-label>
      </ion-chip>
    </div>
    <ng-template #notReady>
      <div class="context-pill">
        <ion-chip color="warning" class="dense">
          <ion-icon name="alert-circle-outline"></ion-icon>
          <ion-label>In attesa del risultato…</ion-label>
        </ion-chip>
      </div>
    </ng-template>

    <!-- Lista messaggi -->
    <div class="messages">
      <ng-container *ngFor="let m of messages; trackBy: trackByIdx">
        <div class="msg" [class.user]="m.role==='user'" [class.assistant]="m.role==='assistant'" [class.system]="m.role==='system'">
          <div class="avatar" *ngIf="m.role!=='system'">
            <ion-icon [name]="m.role==='assistant' ? 'sparkles-outline' : 'person-circle-outline'"></ion-icon>
          </div>
          <div class="bubble">
            <div class="msg-text">{{ m.content }}</div>
          </div>
        </div>
      </ng-container>

      <!-- Indicatore “sta scrivendo…” -->
      <div class="msg assistant typing" *ngIf="sending">
        <div class="avatar">
          <ion-icon name="sparkles-outline"></ion-icon>
        </div>
        <div class="bubble">
          <span class="dots"><span></span><span></span><span></span></span>
        </div>
      </div>

      <!-- Empty state -->
      <div class="empty" *ngIf="messages.length === 0">
        <ion-icon name="chatbubbles-outline" aria-hidden="true"></ion-icon>
        <h3>Inizia la conversazione</h3>
        <p>Scrivi qui sotto la tua domanda sul risultato premium.</p>
      </div>
    </div>

    <!-- Spacer per non far coprire gli ultimi messaggi dal footer -->
    <div class="composer-spacer"></div>
  </div>
</ion-content>

<!-- Composer fisso -->
<ion-footer class="composer-footer">
  <ion-toolbar class="composer">
    <ion-item lines="none" class="composer-item">
      <ion-textarea
        [(ngModel)]="input"
        [autoGrow]="true"
        rows="1"
        inputmode="text"
        enterkeyhint="send"
        placeholder="Scrivi un messaggio…"
        (keydown.enter)="onEnter($event)">
      </ion-textarea>

      <ion-buttons slot="end">
        <ion-button [disabled]="!canSend()" (click)="send()" aria-label="Invia">
          <ion-icon name="send-outline" slot="icon-only"></ion-icon>
        </ion-button>
      </ion-buttons>
    </ion-item>
  </ion-toolbar>
</ion-footer>
